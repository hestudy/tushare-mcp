# Story 1.1: 项目骨架与持续集成

## Status

Approved

## Story

**As a** 后端工程师,
**I want** 初始化 MCP 服务仓库与基础框架,
**so that** 团队可以在统一结构下协作并自动验证提交。

## Acceptance Criteria

1. 配置 Monorepo 结构，包含 `metadata/`、`mcp_commands/`、`service/`、`docs/` 等目录。
2. 引入 FastAPI/uvicorn 并提供基础健康检查路由。
3. 建立 CI（Lint + Unit Test）流程，PR 合并需自动执行。
4. 编写 README 说明启动方式与目录结构。

## Tasks / Subtasks

- [x] 目录骨架与配置管理 (AC: 1, 4)
  - [x] 创建并提交 `metadata/`, `mcp_commands/`, `service/`, `docs/`, `infrastructure/`, `shared/`, `tests/` 目录，与 `pyproject.toml`, `Makefile` 等基础文件占位 [Source: architecture/source-tree.md#source-tree]
  - [x] 在 README 中概述目录职责、启动命令与依赖版本 [Source: architecture/high-level-architecture.md#high-level-overview]
- [x] FastAPI 应用基线 (AC: 2)
  - [x] 初始化 `service/app/main.py`，挂载 FastAPI 实例与 `GET /health` 路由返回标准化响应 [Source: architecture/components.md#mcp-api-layer-fastapi]
  - [x] 预留 `api/`, `core/`, `orchestrator/`, `rate_limit/`, `repositories/`, `schemas/`, `security/` 子包结构 [Source: architecture/source-tree.md#source-tree]
- [x] 异步运行与依赖配置 (AC: 2)
  - [x] 配置 `uvicorn` 启动脚本与 `pyproject.toml` 依赖（FastAPI, uvicorn, anyio） [Source: architecture/tech-stack.md#technology-selection-table]
  - [x] 在 `shared/config/` 中创建默认配置占位，包含 tushare Token 读取钩子 [Source: architecture/components.md#auth-secrets-manager]
- [x] CI 与质量保障 (AC: 3)
  - [x] 配置 GitHub Actions Workflow，执行 `ruff` + `black` 检查与 `pytest` 单元测试 [Source: architecture/coding-standards.md#coding-standards]
  - [x] 为 `service/tests/unit/` 添加示例测试，验证健康检查路由返回规范结构 [Source: architecture/test-strategy-and-standards.md#test-types-and-organization]
- [x] 文档与后续扩展对齐 (AC: 4)
  - [x] 在 README 中记录部署策略与后续环境演进路径 [Source: architecture/infrastructure-and-deployment.md#deployment-strategy]
  - [x] 标注未来指令、限频与日志模块在仓库中的位置，指向对应组件 [Source: architecture/components.md#component-diagram]

## Dev Notes

### Previous Story Insights

本故事为项目首个故事，无可继承的前置实施记录。

### Data Models

当前仅搭建服务骨架，不涉及 `DataSource`、`InterfaceMetadata` 等数据模型实现，可在后续元数据相关故事落地 [Source: architecture/data-models.md#data-models]

### API Specifications

FastAPI 层后续需实现 `GET /mcp/commands`, `POST /mcp/execute`, `POST /auth/token` 等接口；本故事只需预留结构并确保健康检查符合统一响应模式 [Source: architecture/rest-api-spec.md#mcpcommands]

### Component Specifications

需为 Metadata Parser、Command Template Generator、Execution Orchestrator、Rate Limit Adapter、Auth Manager、Logging 等组件预留模块目录与依赖占位，保证后续故事按图示对齐 [Source: architecture/components.md#component-diagram]

### File Locations

按统一源代码结构创建目录与文件，使 `service/app/`, `service/tests/`, `shared/config/`, `metadata/`, `mcp_commands/` 等位置与架构文档一致，利于后续自动化脚本与文档同步 [Source: architecture/source-tree.md#source-tree]

### Testing Requirements

单元测试位于 `service/tests/unit/`，使用 `pytest` + `pytest-asyncio`，覆盖健康检查等关键路径；需保持 ≥85% 基线覆盖并为集成测试预留结构 [Source: architecture/test-strategy-and-standards.md#test-types-and-organization]

### Technical Constraints

项目使用 Python 3.11.8、FastAPI 0.111、uvicorn 0.30/ gunicorn 22.0，并结合 structlog/OpenTelemetry、Typer 等依赖；须遵循 `ruff` + `black` 约束、统一请求 ID、禁止明文凭证 [Source: architecture/tech-stack.md#technology-selection-table][Source: architecture/coding-standards.md#coding-standards]

## Testing

- [x] 单元测试：为 `GET /health` 编写 `service/tests/unit/test_health.py`
- [ ] 集成测试：预留 `service/tests/integration/` 结构，后续故事补充
- [ ] 端到端测试：标记依赖 docker-compose 的 CLI 流程，后续故事补充

## Dev Agent Record

### Debug Log
- 2025-09-29: 初始化 FastAPI 健康检查路由与标准化响应，确保返回 `request_id`、依赖版本与 UTC 时间戳。
- 2025-09-29: 创建 `shared/config/settings.py` 以提供 tushare Token 环境变量钩子。

### Completion Notes
- 完成 Monorepo 目录骨架与占位文件，`pyproject.toml`/`Makefile`/`README.md` 已对齐架构规范。
- 健康检查路由符合统一响应要求，并提供 P0 单元测试覆盖。
- GitHub Actions 工作流覆盖 Ruff、Black 与 Pytest，满足 CI 验收标准。

### File List
- `pyproject.toml`
- `README.md`
- `Makefile`
- `.github/workflows/ci.yml`
- `service/app/__init__.py`
- `service/app/main.py`
- `service/tests/unit/test_health.py`
- `shared/config/settings.py`
- 目录占位文件（`.gitkeep` 等）

## Change Log

| Date       | Version | Description                                | Author       |
| ---------- | ------- | ------------------------------------------ | ------------ |
| 2025-09-29 | v0.1    | 草拟故事文档，涵盖骨架、CI、测试与文档任务 | Scrum Master |

## QA Results

### 2025-09-29 追踪评审
- **总结**: 健康检查路由具备完整单元测试，但目录结构、CI 配置与 README 缺乏自动化验证，整体质量门禁存在显著空缺。
- **覆盖情况**:
  - **AC2**: 单元测试 `service/tests/unit/test_health.py::test_health_endpoint_returns_standard_payload` 提供完全覆盖。
  - **AC1 / AC3 / AC4**: 未发现自动化测试或脚本验证，覆盖为空。
- **主要缺口**:
  - **AC1**: 模块骨架与关键目录未做结构校验，建议添加 pytest 脚本通过文件/目录断言验证。
  - **AC3**: CI 工作流缺少自检或 meta 测试，需确保 Ruff/Black/Pytest 任务在流水线中被验证。
  - **AC4**: README 与文档未纳入 lint/链接检查，存在信息漂移风险。
- **改进建议**:
  - 针对 AC1 增加目录结构验证测试并纳入流水线。
  - 为 CI 定义自我验证流程（如使用 `act` 或管道脚本）确保关键任务执行成功。
  - 在 CI 中加入 Markdown lint 或死链检测以守护 README 质量。
- **工件**:
  - Trace matrix: `docs/qa/assessments/1.1-project-bootstrap-ci-trace-20250929.md`

### 2025-09-29 NFR 评估
- **结论**: 安全、性能、可靠性、可维护性均标记为 CONCERNS；项目骨架缺乏安全控制、性能基准、错误处理与足够测试覆盖。
- **关键观察**:
  - **Security**: 仅有 tushare token 钩子，缺少认证/授权与速率限制。
  - **Performance**: 未定义响应时间目标，也未引入监控或压测计划。
  - **Reliability**: 健康检查以外缺乏异常处理、日志与降级机制。
  - **Maintainability**: 目录清晰但测试覆盖仅限健康检查，无法支撑 ≥85% 目标。
- **行动建议**:
  - 引入安全中间件、速率限制与 secrets/依赖扫描。
  - 设定并验证初始性能指标，规划监控与压测脚本。
  - 增加结构化日志、错误处理骨架与可靠性检测。
  - 扩充自动化测试，验证目录结构与配置，提升覆盖率指标。
- **工件**:
  - NFR assessment: `docs/qa/assessments/1.1-project-bootstrap-ci-nfr-20250929.md`

### 2025-09-29 最终评审
- **总结**: 全部验收准则已满足；新增目录结构与安全单元测试显著降低结构与凭证风险，建议后续故事聚焦性能与可靠性基线。
- **覆盖情况**:
  - **AC1**: `service/tests/unit/test_structure.py::test_required_directories_exist` 与 `test_required_files_exist` 验证关键目录与基础文件存在。
  - **AC2**: `service/tests/unit/test_health.py::test_health_endpoint_returns_standard_payload` 覆盖健康检查响应规范。
  - **AC3**: `.github/workflows/ci.yml` 在 push / PR 上执行 Ruff、Black、Pytest 及凭证自检，满足持续集成要求。
  - **AC4**: `README.md` 记录启动方式、目录结构与扩展规划；可在后续加入 Markdown lint 以强化文档质量。
- **新增测试**:
  - `service/tests/unit/test_structure.py`
  - `service/tests/unit/test_security.py`
- **残余风险**:
  - **性能**: 暂未定义性能指标或压测计划，建议在后续故事规划。
  - **可靠性**: 缺少集中日志与异常处理骨架，建议尽早补充以提升可观测性。
